<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æŠ½å–å¹¸è¿æ˜Ÿï½œ</title>
<style>
  :root{--ui:#21e0c0;}
  html,body{height:100%;margin:0;background:#02040a;color:#b7c4c9;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  .app{height:100%;display:grid;grid-template-rows:auto 1fr auto}
  header{padding:.75rem 1rem;background:#0b0f16;border-bottom:1px solid #16202a;letter-spacing:.08em}
  header b{color:var(--ui)}
  #stage{position:relative;overflow:hidden;}
  #stage canvas{display:block}
  .stars{position:absolute;inset:0;pointer-events:none;background:
     radial-gradient(1200px 600px at 80% 10%,rgba(33,224,192,.06),transparent 65%),
     radial-gradient(1000px 600px at 10% 70%,rgba(33,224,192,.05),transparent 60%);}
  footer{display:flex;gap:.75rem;align-items:center;justify-content:center;padding:.75rem;background:#0b0f16;border-top:1px solid #16202a}
  button,input,select{border:1px solid #22303a;background:#0f1620;color:#d8e1e7;border-radius:.5rem;padding:.5rem .9rem;font-size:14px}
  button:hover{border-color:#2f4452}
  button.primary{background:#122a25;border-color:#1e4a42;color:#9ff0df}
  button.draw{background:#2a1a12;border-color:#42341e;color:#f0d89f}
  button.import{background:#1a1a2a;border-color:#342e42;color:#d0c0f0}
  .badge{display:inline-block;padding:.2rem .5rem;border:1px solid #1e4a42;border-radius:.4rem;color:#9ff0df;margin-left:.4rem}
  .tip{opacity:.75;font-size:12px;margin-left:.35rem}
  .import-section{display:flex;align-items:center;gap:.5rem}
  #fileInput{display:none}
  .import-status{font-size:12px;color:#9ff0df;margin-left:.5rem}
  .speech-toggle{display:flex;align-items:center;gap:.3rem;font-size:12px}
  .speech-toggle input[type="checkbox"]{transform:scale(0.8)}
  .result{background:#0f1620;border:1px solid #22303a;border-radius:.5rem;padding:.5rem;margin-top:.5rem;display:none}
  .result.show{display:block}
  .result-names{color:#9ff0df;font-weight:600;margin-top:.3rem}
  
  .overlay{position:fixed;inset:0;background:rgba(2,4,10,0.95);backdrop-filter:blur(8px);z-index:1000;display:none;align-items:center;justify-content:center}
  .overlay.show{display:flex}
  .winner-card{background:linear-gradient(135deg,#122a25,#0e2623);border:2px solid var(--ui);border-radius:1rem;padding:3rem;text-align:center;max-width:80vw;max-height:80vh;overflow-y:auto;position:relative}
  .winner-title{font-size:2.5rem;color:var(--ui);margin-bottom:1.5rem;text-shadow:0 0 20px rgba(33,224,192,0.5)}
  .winner-list{display:flex;flex-wrap:wrap;gap:1rem;justify-content:center;margin:2rem 0}
  .winner-item{background:rgba(33,224,192,0.1);border:1px solid var(--ui);border-radius:.8rem;padding:1.5rem 2rem;font-size:1.8rem;color:#fff;text-shadow:0 0 10px rgba(33,224,192,0.3);transform:scale(0);animation:popIn 0.6s cubic-bezier(0.68,-0.55,0.265,1.55) forwards}
  .winner-item:nth-child(1){animation-delay:0.2s}
  .winner-item:nth-child(2){animation-delay:0.4s}
  .winner-item:nth-child(3){animation-delay:0.6s}
  .winner-item:nth-child(4){animation-delay:0.8s}
  .winner-item:nth-child(5){animation-delay:1.0s}
  .close-btn{position:absolute;top:1rem;right:1rem;background:none;border:2px solid #666;color:#999;border-radius:50%;width:3rem;height:3rem;font-size:1.5rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
  .close-btn:hover{border-color:var(--ui);color:var(--ui)}
  .confetti{position:absolute;width:10px;height:10px;background:var(--ui);animation:confetti 3s linear infinite}
  
  @keyframes popIn{
    0%{transform:scale(0) rotate(180deg);opacity:0}
    50%{transform:scale(1.1) rotate(0deg);opacity:0.8}
    100%{transform:scale(1) rotate(0deg);opacity:1}
  }
  
  @keyframes confetti{
    0%{transform:translateY(-100vh) rotate(0deg);opacity:1}
    100%{transform:translateY(100vh) rotate(360deg);opacity:0}
  }
  
  a{color:#9ff0df;text-decoration:none}
</style>
</head>
<body>
<div class="app">
  <header>
    <b>ä¸Šæµ· XXX å­¦æ ¡ ä¸‰å››ç­ éšæœºç‚¹åç¨‹åº</b>
    
  </header>
  

  <div id="stage">
    <!-- æ˜Ÿç©ºå å±‚ï¼ˆçº¯ CSS å…‰æ™•ï¼‰ï¼ŒThree.js ç”»å¸ƒä¼šæ’åœ¨ä¸‹é¢ -->
    <div class="stars"></div>
  </div>

  <footer>
    <button id="btnStart" class="primary">å¼€å§‹</button>
    <button id="btnStop">åœæ­¢</button>
    <button id="btnReset">é‡ç½®</button>
    <label>ç‚¹åæ•°é‡
      <select id="drawCount">
        <option value="1">1äºº</option>
        <option value="2">2äºº</option>
        <option value="3">3äºº</option>
        <option value="4">4äºº</option>
        <option value="5">5äºº</option>
      </select>
    </label>
    <button id="btnDraw" class="draw">æŠ½å–</button>
    
    <div class="import-section">
      <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
      <button id="btnImport" class="import">å¯¼å…¥Excel</button>
      <span id="importStatus" class="import-status"></span>
    </div>
    
    <label class="speech-toggle">
      <input type="checkbox" id="speechEnabled" checked />
      è¯­éŸ³æ’­æŠ¥
    </label>
    
    <span class="tip">æç¤ºï¼šå¯¼å…¥Excelåå• â†’ é€‰æ‹©äººæ•° â†’ ç‚¹å‡»æŠ½å– â†’ åŒå‡»ç”»é¢æš‚åœæ—‹è½¬</span>
  </footer>
  
  <div id="result" class="result">
    <div>ğŸ¯ æŠ½å–ç»“æœï¼š</div>
    <div id="resultNames" class="result-names"></div>
  </div>
</div>

<!-- å…¨å±è·å¥–è€…å±•ç¤ºå±‚ -->
<div id="overlay" class="overlay">
  <div class="winner-card">
    <button id="closeBtn" class="close-btn">Ã—</button>
    <div class="winner-title">ğŸ‰ éšæœºç‚¹å</div>
    <div id="winnerList" class="winner-list"></div>
  </div>
</div>

<!-- Three.jsï¼ˆæœ¬åœ°åŒ–ï¼‰-->
<script src="three.min.js"></script>
<!-- SheetJSï¼ˆæœ¬åœ°åŒ–ï¼‰-->
<script src="xlsx.full.min.js"></script>

<script>
/** ============ æ•°æ®ï¼ˆæ”¯æŒExcelå¯¼å…¥è¦†ç›–ï¼‰ ============ */
let baseNames = [
  "ç¬¬ä¸€æ­¥ excelå¯¼å…¥ ","ç¬¬äºŒæ­¥ é€‰æ‹©æ•°é‡","ç¬¬ä¸‰æ­¥ ç‚¹å",
];

/** ============ åŸºç¡€åœºæ™¯ ============ */
let scene, camera, renderer, group, animating = true, spin = 0.35, dragging = false;
const stage = document.getElementById('stage');

init();
makeSphere(baseNames.length);  // æ ¹æ®åå•æ•°é‡è‡ªåŠ¨è®¾ç½®
animate();

function init(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x05070d);

  const w = stage.clientWidth || window.innerWidth;
  const h = stage.clientHeight || (window.innerHeight - 120);
  camera = new THREE.PerspectiveCamera(55, w/h, 0.1, 2000);
  camera.position.set(0, 0, 380);

  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference:'high-performance' });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(w, h);
  stage.prepend(renderer.domElement);

  // æŸ”å…‰ç¯å¢ƒ
  const amb = new THREE.AmbientLight(0x95fff0, 0.35);
  scene.add(amb);
  const dir = new THREE.DirectionalLight(0x71ffe8, 0.4);
  dir.position.set(2,2,3);
  scene.add(dir);

  // ç‚¹æ˜Ÿç©º
  const starGeo = new THREE.BufferGeometry();
  const starCnt = 1200, starPos = new Float32Array(starCnt*3);
  for(let i=0;i<starCnt;i++){
    starPos[i*3+0] = (Math.random()-0.5)*2000;
    starPos[i*3+1] = (Math.random()-0.5)*2000;
    starPos[i*3+2] = (Math.random()-0.5)*2000;
  }
  starGeo.setAttribute('position', new THREE.BufferAttribute(starPos,3));
  const starMat = new THREE.PointsMaterial({ color:0x89efff, size:1, sizeAttenuation:true, transparent:true, opacity:.7 });
  const stars = new THREE.Points(starGeo, starMat);
  scene.add(stars);

  // é¼ æ ‡æ‹–æ‹½æ—‹è½¬
  let sx=0, sy=0;
  stage.addEventListener('pointerdown', e=>{ dragging=true; sx=e.clientX; sy=e.clientY; });
  window.addEventListener('pointerup', ()=> dragging=false );
  window.addEventListener('pointermove', e=>{
    if(!dragging || !group) return;
    const dx = (e.clientX - sx) * 0.003;
    const dy = (e.clientY - sy) * 0.003;
    group.rotation.y += dx;
    group.rotation.x += dy;
    sx = e.clientX; sy = e.clientY;
  });
  stage.addEventListener('dblclick', ()=> animating = !animating );
  window.addEventListener('resize', onResize);
}

function onResize(){
  const w = stage.clientWidth || window.innerWidth;
  const h = stage.clientHeight || (window.innerHeight - 120);
  camera.aspect = w/h; camera.updateProjectionMatrix();
  renderer.setSize(w,h);
}

/** ============ ç”Ÿæˆåå­—ç²¾çµè´´å›¾ ============ */
function makeLabelTexture(text, size=160){  // å¢å¤§ç”»å¸ƒä»¥å®¹çº³é•¿åå­—
  const c = document.createElement('canvas');
  c.width = c.height = size;
  const ctx = c.getContext('2d');

  // å‘å…‰æ•ˆæœ
  ctx.shadowColor = 'rgba(33,224,192,0.75)';
  ctx.shadowBlur = 18;

  // å°ç†Šå›¾æ¡ˆ - æ”¾åœ¨ä¸Šæ–¹ï¼Œç¨å¾®ç¼©å°
  ctx.font = '56px "Apple Color Emoji","Segoe UI Emoji"';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('ğŸ§¸', size/2, size/2 - 35);

  // è‡ªé€‚åº”å­—ä½“å¤§å°å¤„ç†é•¿åå­—
  let fontSize = 20;
  let font = `600 ${fontSize}px "Microsoft YaHei", "Noto Sans SC", system-ui`;
  ctx.font = font;
  
  // æµ‹é‡æ–‡å­—å®½åº¦å¹¶è°ƒæ•´å­—ä½“å¤§å°
  const maxWidth = size - 16; // ç•™å‡º8pxè¾¹è·
  let textWidth = ctx.measureText(text).width;
  
  while (textWidth > maxWidth && fontSize > 12) {
    fontSize -= 1;
    font = `600 ${fontSize}px "Microsoft YaHei", "Noto Sans SC", system-ui`;
    ctx.font = font;
    textWidth = ctx.measureText(text).width;
  }

  // å¦‚æœåå­—ä»ç„¶å¤ªé•¿ï¼Œè¿›è¡Œæ¢è¡Œå¤„ç†
  if (textWidth > maxWidth) {
    const words = text.split('Â·'); // ç»´å¾å°”æ—åå­—é€šå¸¸ç”¨Â·åˆ†éš”
    if (words.length > 1) {
      // ä¸¤è¡Œæ˜¾ç¤º
      ctx.fillStyle = '#9ff0df';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(words[0], size/2, size/2 + 20);
      ctx.fillText(words[1], size/2, size/2 + 45);
    } else {
      // å¼ºåˆ¶æ¢è¡Œï¼ˆå–ä¸­é—´ä½ç½®æ–­å¼€ï¼‰
      const mid = Math.floor(text.length / 2);
      const line1 = text.substring(0, mid);
      const line2 = text.substring(mid);
      ctx.fillStyle = '#9ff0df';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(line1, size/2, size/2 + 20);
      ctx.fillText(line2, size/2, size/2 + 45);
    }
  } else {
    // å•è¡Œæ˜¾ç¤º
    ctx.fillStyle = '#9ff0df';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(text, size/2, size/2 + 32);
  }

  const tex = new THREE.CanvasTexture(c);
  tex.anisotropy = renderer.capabilities.getMaxAnisotropy?.() || 1;
  return tex;
}

/** ============ æ–æ³¢é‚£å¥‘çƒé¢åˆ†å¸ƒ + Spriteæœå‘ç›¸æœº ============ */
function makeSphere(count=120){
  if(group){ scene.remove(group); group.traverse(o=>o.material?.map?.dispose?.()); group.clear(); }
  group = new THREE.Group();
  scene.add(group);

  const R = 140;
  const names = fillNames(count);
  const phi = Math.PI * (3 - Math.sqrt(5)); // golden angle

  for(let i=0;i<count;i++){
    // ä¿®å¤æç‚¹é—®é¢˜ï¼šé¿å…y=Â±1çš„æƒ…å†µï¼Œç•™å‡ºå°çš„è¾¹è·
    const y = 1 - ((i + 0.5) / count) * 2; // y from 0.99... to -0.99...
    const radius = Math.sqrt(1 - y * y);
    const theta = phi * i;

    const x = Math.cos(theta) * radius;
    const z = Math.sin(theta) * radius;

    const tex = makeLabelTexture(names[i % names.length]);
    const mat = new THREE.SpriteMaterial({ map: tex, transparent: true });
    const sprite = new THREE.Sprite(mat);
    sprite.position.set(x*R, y*R, z*R);
    sprite.scale.set(55, 55, 55); // è°ƒæ•´å¤§å°é€‚åº”æ–°Canvaså°ºå¯¸(160px)
    group.add(sprite);
  }
  // åˆå§‹æ…¢é€Ÿè‡ªè½¬
  group.rotation.y = Math.random()*Math.PI*2;
  group.rotation.x = (Math.random()*.3)-.15;
}

function fillNames(n){
  const out = [];
  while(out.length < n){
    out.push(...shuffle([...baseNames]));
  }
  return out.slice(0,n);
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]] } return a; }

/** ============ åŠ¨ç”»å¾ªç¯ ============ */
function animate(){
  requestAnimationFrame(animate);
  if(group && animating){
    group.rotation.y += spin * 0.1;   // è‡ªè½¬ (æé«˜50%é€Ÿåº¦)
  }
  renderer.render(scene, camera);
}

/** ============ UI äº¤äº’ ============ */
const btnStart = document.getElementById('btnStart');
const btnStop  = document.getElementById('btnStop');
const btnReset = document.getElementById('btnReset');
const btnDraw  = document.getElementById('btnDraw');
const btnImport = document.getElementById('btnImport');
const fileInput = document.getElementById('fileInput');
const importStatus = document.getElementById('importStatus');
const speechEnabled = document.getElementById('speechEnabled');
const drawCountSel = document.getElementById('drawCount');
const resultDiv = document.getElementById('result');
const resultNames = document.getElementById('resultNames');
const overlay = document.getElementById('overlay');
const winnerList = document.getElementById('winnerList');
const closeBtn = document.getElementById('closeBtn');

btnStart.onclick = ()=>{ animating = true; spin = Math.min(1.2, Math.max(.1, spin)); };
btnStop.onclick  = ()=>{ animating = false; };
btnReset.onclick = ()=>{
  spin = 0.35;
  if(group){ group.rotation.set( (Math.random()*.3)-.15, Math.random()*Math.PI*2, 0 ); }
  animating = true;
  resultDiv.classList.remove('show');
  overlay.classList.remove('show');
};

btnDraw.onclick = ()=>{
  const drawCount = parseInt(drawCountSel.value, 10);
  drawLuckyNames(drawCount);
};

// å…³é—­å…¨å±å±•ç¤º
closeBtn.onclick = ()=>{
  overlay.classList.remove('show');
};

// ç‚¹å‡»èƒŒæ™¯å…³é—­
overlay.onclick = (e)=>{
  if(e.target === overlay) {
    overlay.classList.remove('show');
  }
};

// Excelå¯¼å…¥åŠŸèƒ½
btnImport.onclick = ()=>{
  fileInput.click();
};

fileInput.onchange = (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  
  importStatus.textContent = 'æ­£åœ¨è§£æ...';
  importStatus.style.color = '#f0d89f';
  
  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const data = new Uint8Array(event.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      
      // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
      
      // æå–æ‰€æœ‰éç©ºçš„æ–‡æœ¬æ•°æ®ä½œä¸ºåå­—
      const names = [];
      jsonData.forEach(row => {
        row.forEach(cell => {
          if(cell && typeof cell === 'string' && cell.trim()) {
            names.push(cell.trim());
          }
        });
      });
      
      if(names.length === 0) {
        throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„åå­—æ•°æ®');
      }
      
      // è¦†ç›–åŸæœ‰æ•°æ®
      baseNames = names;
      
      // é‡æ–°ç”Ÿæˆçƒä½“ä½¿ç”¨æ–°æ•°æ®é•¿åº¦
      makeSphere(baseNames.length);
      
      // æ›´æ–°ç‚¹åæ•°é‡é€‰é¡¹
      updateDrawCountOptions();
      
      importStatus.textContent = `å·²å¯¼å…¥${names.length}ä¸ªåå­—`;
      importStatus.style.color = '#9ff0df';
      
      // 3ç§’åæ¸…é™¤çŠ¶æ€æç¤º
      setTimeout(() => {
        importStatus.textContent = '';
      }, 3000);
      
    } catch (error) {
      importStatus.textContent = `å¯¼å…¥å¤±è´¥: ${error.message}`;
      importStatus.style.color = '#ff6b6b';
      
      setTimeout(() => {
        importStatus.textContent = '';
      }, 5000);
    }
  };
  
  reader.readAsArrayBuffer(file);
  
  // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
  e.target.value = '';
};

/** ============ æŠ½å–å¹¸è¿åå­— ============ */
function drawLuckyNames(count) {
  if (!group || !group.children.length) {
    alert('è¯·å…ˆç”Ÿæˆçƒä½“ï¼');
    return;
  }
  
  // åœæ­¢åŠ¨ç”»ä¾¿äºè§‚çœ‹ç»“æœ
  animating = false;
  
  // è·å–å½“å‰çƒä½“ä¸Šçš„æ‰€æœ‰åå­—
  const allNames = [];
  const currentNames = fillNames(group.children.length);
  
  // ä»å½“å‰æ˜¾ç¤ºçš„åå­—ä¸­éšæœºæŠ½å–
  const shuffled = shuffle([...currentNames]);
  const selected = shuffled.slice(0, count);
  
  // é«˜äº®æ˜¾ç¤ºè¢«é€‰ä¸­çš„ç²¾çµ
  highlightSelected(selected);
  
  // æ˜¾ç¤ºç»“æœ
  resultNames.textContent = selected.join('ã€');
  resultDiv.classList.add('show');
  
  // æ˜¾ç¤ºå…¨å±è·å¥–è€…å±•ç¤º
  showWinnersOverlay(selected);
  
  // è¯­éŸ³æ’­æŠ¥è·å¥–è€…å§“å
  if(speechEnabled.checked) {
    speakNames(selected);
  }
}

/** ============ é«˜äº®é€‰ä¸­çš„åå­— ============ */
function highlightSelected(selectedNames) {
  if (!group) return;
  
  // é‡ç½®æ‰€æœ‰ç²¾çµ
  group.children.forEach(sprite => {
    sprite.scale.set(55, 55, 55); // è°ƒæ•´ä¸ºæ–°çš„é»˜è®¤å¤§å°
    if (sprite.material && sprite.material.color) {
      sprite.material.color.setHex(0xffffff);
    }
  });
  
  // é«˜äº®é€‰ä¸­çš„ç²¾çµ
  const currentNames = fillNames(group.children.length);
  selectedNames.forEach(name => {
    const index = currentNames.indexOf(name);
    if (index >= 0 && group.children[index]) {
      const sprite = group.children[index];
      sprite.scale.set(82, 82, 82); // é«˜äº®æ—¶æ”¾å¤§(55 * 1.5)
      if (sprite.material && sprite.material.color) {
        sprite.material.color.setHex(0xffff00); // é»„è‰²é«˜äº®
      }
    }
  });
}

/** ============ å…¨å±è·å¥–è€…å±•ç¤º ============ */
function showWinnersOverlay(winners) {
  // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
  winnerList.innerHTML = '';
  
  // ä¸ºæ¯ä¸ªè·å¥–è€…åˆ›å»ºå¡ç‰‡
  winners.forEach((name, index) => {
    const winnerItem = document.createElement('div');
    winnerItem.className = 'winner-item';
    winnerItem.textContent = name;
    winnerItem.style.animationDelay = `${0.2 + index * 0.2}s`;
    winnerList.appendChild(winnerItem);
  });
  
  // æ˜¾ç¤ºè¦†ç›–å±‚
  overlay.classList.add('show');
  
  // æ·»åŠ å½©å¸¦æ•ˆæœ
 // createConfetti();
}

/** ============ å½©å¸¦åŠ¨ç”»æ•ˆæœ ============ */
function createConfetti() {
  const colors = ['#21e0c0', '#71ffe8', '#95fff0', '#9ff0df'];
  
  for(let i = 0; i < 50; i++) {
    setTimeout(() => {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
      confetti.style.animationDelay = Math.random() * 2 + 's';
      overlay.appendChild(confetti);
      
      // 3ç§’åç§»é™¤
      setTimeout(() => {
        if(confetti.parentNode) {
          confetti.parentNode.removeChild(confetti);
        }
      }, 5000);
    }, i * 100);
  }
}

/** ============ è¯­éŸ³æ’­æŠ¥åŠŸèƒ½ ============ */
function speakNames(names) {
  if (!window.speechSynthesis) {
    console.warn('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆAPI');
    return;
  }
  
  // åœæ­¢æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„è¯­éŸ³
  speechSynthesis.cancel();
  
  // è®¾ç½®è¯­éŸ³å‚æ•°
  const createUtterance = (text) => {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'zh-CN';
    utterance.rate = 1;    // è¯­é€Ÿç¨æ…¢
    utterance.pitch = 1.1;   // éŸ³è°ƒç¨é«˜
    utterance.volume = 1;  // éŸ³é‡
    return utterance;
  };
  
  if (names.length === 1) {
    // å•äººï¼šç›´æ¥æ’­æŠ¥
    const utterance = createUtterance(`ç‚¹åˆ°çš„åå­—æ˜¯ ${names[0]}`);
    utterance.onend = () => {
      // æ’­æŠ¥å®Œæˆåè¿˜åŸçŠ¶æ€
      restoreInitialState();
    };
    speechSynthesis.speak(utterance);
  } else {
    // å¤šäººï¼šä¾æ¬¡æ’­æŠ¥ï¼Œä¸­é—´åœé¡¿
    let index = 0;
    
    const speakNext = () => {
      if (index >= names.length) return;
      
      const name = names[index];
      const text = index === 0 ? `ç‚¹åˆ°çš„åå­—æ˜¯ ${name}` : name;
      const utterance = createUtterance(text);
      
      utterance.onend = () => {
        index++;
        if (index < names.length) {
          // 0.5ç§’åæ’­æŠ¥ä¸‹ä¸€ä¸ª
          setTimeout(speakNext, 50);
        } else {
          // æ‰€æœ‰æ’­æŠ¥å®Œæˆåè¿˜åŸçŠ¶æ€
          restoreInitialState();
        }
      };
      
      utterance.onerror = () => {
        console.warn('è¯­éŸ³æ’­æŠ¥å‡ºé”™');
        index++;
        if (index < names.length) {
          setTimeout(speakNext, 1000);
        }
      };
      
      speechSynthesis.speak(utterance);
    };
    
    speakNext();
  }
}

/** ============ æ£€æŸ¥è¯­éŸ³æ”¯æŒ ============ */
function checkSpeechSupport() {
  if (!window.speechSynthesis) {
    speechEnabled.disabled = true;
    speechEnabled.checked = false;
    speechEnabled.parentElement.title = 'æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ';
    return false;
  }
  return true;
}

/** ============ åŠ¨æ€æ›´æ–°ç‚¹åæ•°é‡é€‰é¡¹ ============ */
function updateDrawCountOptions() {
  const currentCount = baseNames.length;
  drawCountSel.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹
  
  // ç”Ÿæˆä»1åˆ°å½“å‰äººæ•°çš„é€‰é¡¹
  for (let i = 1; i <= currentCount; i++) {
    const option = document.createElement('option');
    option.value = i;
    option.textContent = `${i}äºº`;
    drawCountSel.appendChild(option);
  }
  
  // é»˜è®¤é€‰ä¸­1äºº
  drawCountSel.value = '1';
}

/** ============ è¿˜åŸåˆå§‹çŠ¶æ€ ============ */
function restoreInitialState() {
  // å»¶è¿Ÿ2ç§’åæ‰§è¡Œè¿˜åŸ
  setTimeout(() => {
    // å…³é—­å…¨å±å±•ç¤ºå±‚
    overlay.classList.remove('show');
    
    // éšè—åº•éƒ¨ç»“æœæ˜¾ç¤º
    resultDiv.classList.remove('show');
    
    // é‡ç½®æ‰€æœ‰ç²¾çµåˆ°é»˜è®¤çŠ¶æ€
    if (group && group.children.length > 0) {
      group.children.forEach(sprite => {
        sprite.scale.set(55, 55, 55);
        if (sprite.material && sprite.material.color) {
          sprite.material.color.setHex(0xffffff);
        }
      });
    }
    
    // æ¢å¤è‡ªè½¬åŠ¨ç”»
    animating = true;
    spin = 0.35; // é‡ç½®ä¸ºé»˜è®¤è½¬é€Ÿ
    
    // éšæœºè®¾ç½®ä¸€ä¸ªæ–°çš„æ—‹è½¬èµ·å§‹ä½ç½®
    if (group) {
      group.rotation.set(
        (Math.random() * 0.3) - 0.15,
        Math.random() * Math.PI * 2,
        0
      );
    }
  }, 2000);
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è¯­éŸ³æ”¯æŒå’Œåˆå§‹åŒ–é€‰é¡¹
window.addEventListener('load', () => {
  checkSpeechSupport();
  updateDrawCountOptions(); // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç‚¹åæ•°é‡é€‰é¡¹
});

</script>
</body>
</html>
